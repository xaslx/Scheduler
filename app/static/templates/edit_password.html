{% extends "base.html" %}

{% block title %}Смена пароля{% endblock %}

{% block content %}

    <div class="registration-form">
        <h2>Изменение пароля</h2>
        <input type="hidden" id="user-id" value="{{ user.id }}">
        <input type="hidden" id="user-email" value="{{ user.email }}">
        <form id="registration-form">
            <div class="form-group">
                <label for="new-password">Новый пароль:</label>
                <div class="password-container">
                    <input type="password" id="new-password" name="new_password" required>
                    <img class="eye" src="/app/static/eye.png" alt="Показать пароль" id="toggle-password">
                </div>
                <p id="password-validation-error" class="error-message">Пароль должен содержать от 6 до 30 символов и состоять из букв, цифр, дефисов или подчеркиваний!</p>
            </div>
            <div class="form-group">
                <label for="confirm-password">Повторите пароль:</label>
                <div class="password-container">
                    <input type="password" id="confirm-password" name="confirm_password" required>
                    <img class="eye" src="/app/static/eye.png" alt="Показать пароль" id="toggle-password-confirm">
                </div>
                <p id="password-error" class="error-message">Пароли не совпадают!</p>
            </div>
            <button type="submit" id="change-password-btn">Изменить</button>
        </form>
    </div>

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <style>
    .error-message {
        color: red;
        font-weight: bold;
        display: none;
    }

    .password-container {
        position: relative;
        display: inline-block;
        width: 100%;
    }

    .eye {
        position: absolute;
        right: 10px;
        top: 50%;
        transform: translateY(-50%);
        cursor: pointer;
    }

    .custom-swal {
        font-size: 16px;
        width: 80%;
        max-width: 300px;
    }

    @media (max-width: 768px) {
        .custom-swal {
            width: 90%;
            max-width: none;
        }
    }
    @media (max-width: 768px) {
        .registration-form {
            width: 90%;
            padding: 15px;
        }
    }
    </style>
    <script>
        function validatePassword(password) {
            return /^[A-Za-z0-9_-]{6,30}$/.test(password);
        }

        document.getElementById('registration-form').addEventListener('submit', function(event) {
            event.preventDefault();

            var newPassword = document.getElementById('new-password').value;
            var confirmPassword = document.getElementById('confirm-password').value;
            var errorElement = document.getElementById('password-error');
            var validationErrorElement = document.getElementById('password-validation-error');

            if (!validatePassword(newPassword)) {
                validationErrorElement.style.display = 'block';
                setTimeout(function() {
                    validationErrorElement.style.display = 'none';
                }, 2000);
                return;
            }

            if (newPassword !== confirmPassword) {
                errorElement.style.display = 'block';
                setTimeout(function() {
                    errorElement.style.display = 'none';
                }, 2000);
            } else {
                var userId = document.getElementById('user-id').value;
                var email = document.getElementById('user-email').value;
                var data = {
                    user_id: userId,
                    email: email,
                    new_password: newPassword,
                    repeat_password: confirmPassword
                };

                fetch('/user/edit_password', {
                    method: 'PATCH',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(data)
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Ошибка при изменении пароля');
                    }

                    Swal.fire({
                        icon: 'success',
                        title: 'Пароль изменен!',
                        showConfirmButton: false,
                        timer: 1500,
                        customClass: {
                            popup: 'custom-swal',
                            title: 'custom-swal-title',
                            content: 'custom-swal-content'
                        },
                        width: '80%',
                    });

                    setTimeout(() => {
                        location.reload();
                    }, 2000);
                })
                .catch(error => {
                    console.error('Ошибка:', error);
                    alert('Произошла ошибка при изменении пароля');
                });
            }
        });

        var togglePassword = document.getElementById('toggle-password');
        var togglePasswordConfirm = document.getElementById('toggle-password-confirm');
        var newPasswordInput = document.getElementById('new-password');
        var confirmPasswordInput = document.getElementById('confirm-password');

        togglePassword.addEventListener('click', function() {
            var type = newPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            newPasswordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'Показать пароль' : 'Скрыть пароль';
        });

        togglePasswordConfirm.addEventListener('click', function() {
            var type = confirmPasswordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            confirmPasswordInput.setAttribute('type', type);
            this.textContent = type === 'password' ? 'Показать пароль' : 'Скрыть пароль';
        });
    </script>
{% endblock %}
